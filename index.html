<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ounass Outfit Generator</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <!-- React and Babel for single-file JSX compilation -->
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <style>
    body { font-family: 'Inter', sans-serif; }
    input:focus, button:focus, textarea:focus { outline: none; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.5); }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useRef } = React;

    // The main App component containing all logic and UI
    const App = () => {
      const [skus, setSkus] = useState(['', '']);
      const [productImages, setProductImages] = useState({});
      const [selectedImages, setSelectedImages] = useState({});
      const [prompts, setPrompts] = useState({ studio: '', lifestyle: '' });
      const [selectedPrompt, setSelectedPrompt] = useState('studio');
      const [generatedImage, setGeneratedImage] = useState(null);
      const [loadingState, setLoadingState] = useState('IDLE'); // More granular loading state
      const [error, setError] = useState(null);
      const [currentStep, setCurrentStep] = useState(1);
      const [showLifestyleForm, setShowLifestyleForm] = useState(false);
      const [lifestyleInputs, setLifestyleInputs] = useState({ location: '', mood: '', time: '', extra: '' });
    
      // Helper function to fetch a URL with a retry mechanism
      const fetchWithRetry = async (url, retries = 3) => {
        for (let i = 0; i < retries; i++) {
          try {
            const response = await fetch(url, {
              // Add cache control for better performance
              cache: 'no-cache',
              // Add timeout for individual requests
              signal: AbortSignal.timeout(10000) // 10 second timeout per request
            });
            
            if (response.ok) {
              return response;
            }
            
            // If response is not ok, don't retry immediately
            if (response.status >= 400 && response.status < 500) {
              throw new Error(`Client error: ${response.status}`);
            }
            
          } catch (e) {
            console.log(`[Retry ${i + 1}/${retries}] Attempt failed for ${url}: ${e.message}`);
            
            if (i === retries - 1) throw e;
            
            // Exponential backoff with jitter for better performance
            const delay = Math.pow(2, i) * 100 + Math.random() * 100;
            await new Promise(resolve => setTimeout(resolve, delay));
          }
        }
        throw new Error('All fetch attempts failed.');
      };
    
      // Fetches images for a given SKU from the Ounass API using a proxy to bypass CORS
      const fetchImages = async () => {
        setError(null);
        setLoadingState('FETCHING_IMAGES');
        const validSkus = skus.filter(s => s);
        
        if (validSkus.length < 2) {
          setError('Please enter at least 2 SKUs.');
          setLoadingState('IDLE');
          return;
        }
    
        // Logging the start of the process
        console.log(`[Initiating] Starting image fetching process for ${validSkus.length} SKUs.`);
        
        // Performance tracking
        const startTime = performance.now();
    
        // Creating an array of promises to fetch all SKUs concurrently with timeout
        const fetchPromises = validSkus.map(sku => {
          // Try multiple proxy services for better reliability and speed
          const proxyUrls = [
            `https://api.allorigins.win/get?url=${encodeURIComponent(`https://www.ounass.ae/product/findbysku?sku=${sku}`)}`,
            `https://cors-anywhere.herokuapp.com/https://www.ounass.ae/product/findbysku?sku=${sku}`,
            `https://thingproxy.freeboard.io/fetch/https://www.ounass.ae/product/findbysku?sku=${sku}`
          ];
          
          console.log(`[Step 1] Sending API request for SKU ${sku} via multiple proxies.`);
          
          // Add timeout to prevent hanging requests
          const timeoutPromise = new Promise((_, reject) => 
            setTimeout(() => reject(new Error('Request timeout')), 8000) // Reduced to 8 seconds
          );
          
          // Try proxies in sequence until one works
          const tryProxies = async () => {
            for (let i = 0; i < proxyUrls.length; i++) {
              try {
                console.log(`[Step 1.${i + 1}] Trying proxy ${i + 1} for SKU ${sku}`);
                const response = await fetch(proxyUrls[i], {
                  cache: 'no-cache',
                  signal: AbortSignal.timeout(8000)
                });
                
                if (response.ok) {
                  console.log(`[Success] Proxy ${i + 1} worked for SKU ${sku}`);
                  return response;
                }
              } catch (e) {
                console.log(`[Warning] Proxy ${i + 1} failed for SKU ${sku}: ${e.message}`);
                if (i === proxyUrls.length - 1) throw e;
              }
            }
            throw new Error('All proxies failed');
          };
          
          const fetchPromise = tryProxies().then(response => {
            if (!response) {
                console.error("No response from fetchWithRetry for SKU:", sku);
                throw new Error("No response from fetchWithRetry.");
            }
            if (!response.ok) {
                console.error("API response was not ok:", response);
                throw new Error('API response failed.');
            }
            return response.json();
          }).then(data => {
            const content = JSON.parse(data.contents);
            const imageSrcs = content.media
              .filter(m => m.mediaType === 'image')
              .map(m => `https://ounass-ae.atgcdn.ae/pub/media/catalog/product${m.src}`);
    
            if (imageSrcs.length > 0) {
              console.log(`[Success] Found ${imageSrcs.length} images for SKU ${sku}.`);
              const brand = content.analytics?.brand || 'Unknown Brand';
              const name = content.analytics?.name || 'Unknown Product';
              const category = content.analytics?.department || content.analytics?.class || 'Unknown Category';
              return {
                sku,
                images: {
                  srcs: imageSrcs,
                  description: `${brand} ${name} (${category})`,
                  brand,
                  name,
                  category
                }
              };
            } else {
              console.warn(`[Warning] No images found for SKU ${sku}.`);
              throw new Error(`No images found for SKU ${sku}.`);
            }
          }).catch(e => {
            console.error(`[Error] An error occurred for SKU ${sku}: ${e.message}`);
            return { sku, error: e.message };
          });
          
          // Race between fetch and timeout
          return Promise.race([fetchPromise, timeoutPromise]);
        });
    
        let images = {};
        let firstError = null;
        let successCount = 0;
    
        // Process results as they complete (faster feedback)
        const results = await Promise.allSettled(fetchPromises);
        
        results.forEach((result, index) => {
          if (result.status === 'fulfilled' && result.value && result.value.images) {
            images[result.value.sku] = result.value.images;
            successCount++;
            // Update progress in real-time
            setProductImages(prev => ({ ...prev, [result.value.sku]: result.value.images }));
          } else if (result.status === 'rejected' && result.reason && !firstError) {
            firstError = result.reason;
          }
        });
    
        const endTime = performance.now();
        const totalTime = Math.round(endTime - startTime);
        
        console.log(`[Completed] Total images for ${successCount} SKUs successfully fetched in ${totalTime}ms.`);
        
        setProductImages(images);
        setLoadingState('IDLE');
    
        if (firstError) {
          setError(`An error occurred: ${firstError}`);
        } else if (successCount >= 2) {
          setCurrentStep(2);
        } else {
          setError('At least two valid SKUs with images are required.');
        }
      };
    
      // Generates a single prompt based on a type
      const refreshPrompt = async (type) => {
        setLoadingState('GENERATING_PROMPTS');
        setError(null);
    
        const productDetails = Object.values(productImages).map(item => ({
          brand: item.brand,
          name: item.name,
          category: item.category
        }));
        const productList = productDetails.map(p => `${p.brand} ${p.name} (${p.category})`).join(', ');
    
        try {
          if (type === 'studio') {
            const response = await fetch('/api/gemini-prompt', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ type: 'studio', productList })
            });

            if (!response.ok) throw new Error('API request failed');
            const result = await response.json();
            
            if (result.success) {
              setPrompts(prev => ({ ...prev, studio: result.prompt }));
            } else {
              throw new Error(result.error || 'Failed to generate prompt');
            }
    
          } else if (type === 'lifestyle') {
            // Lifestyle prompt'u başlangıçta boş bırak, sadece kullanıcı generate butonuna tıkladığında oluştur
            setPrompts(prev => ({ ...prev, lifestyle: '' }));
          }
        } catch (e) {
          setError(`An error occurred while generating the prompt: ${e.message}`);
        } finally {
          setLoadingState('IDLE');
        }
      };
    
    
      // Generates both prompts initially
      const generatePrompts = async () => {
        setLoadingState('GENERATING_PROMPTS');
        await refreshPrompt('studio');
        await refreshPrompt('lifestyle'); // Keep this for initial prompt generation
        setCurrentStep(3);
        setLoadingState('IDLE');
      };
      
      // Generates the lifestyle prompt based on user inputs using Gemini API
      const generateLifestylePrompt = async () => {
        setLoadingState('GENERATING_PROMPTS');
        setError(null);
        try {
          const { location, mood, time, extra } = lifestyleInputs;
          const productDetails = Object.values(productImages).map(item => ({
            brand: item.brand,
            name: item.name,
            category: item.category
          }));
          const productList = productDetails.map(p => `${p.brand} ${p.name} (${p.category})`).join(', ');
    
          const response = await fetch('/api/gemini-prompt', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
              type: 'lifestyle', 
              productList, 
              lifestyleInputs: { location, mood, time, extra } 
            })
          });

          if (!response.ok) throw new Error('API request failed');
          const result = await response.json();
          
          if (result.success) {
            setPrompts(prev => ({ ...prev, lifestyle: result.prompt }));
            setShowLifestyleForm(false);
          } else {
            throw new Error(result.error || 'Failed to generate prompt');
          }
        } catch (e) {
          setError(`An error occurred while generating the prompt: ${e.message}`);
        } finally {
          setLoadingState('IDLE');
        }
      };
    
      // Helper function to convert a URL to a Base64 string
      const urlToBase64 = async (url) => {
        const response = await fetch(url);
        const blob = await response.blob();
        return new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onloadend = () => {
            resolve(reader.result);
          };
          reader.onerror = reject;
          reader.readAsDataURL(blob);
        });
      };
    
      // Handles the final image generation call to the API
      const handleGenerateImage = async () => {
        if (!selectedPrompt || !prompts[selectedPrompt]) {
          setError('Please select a prompt.');
          return;
        }
    
        setError(null);
        setLoadingState('UPLOADING_IMAGES');
    
        try {
          const selectedImageUrls = Object.values(selectedImages);
          const base64Images = await Promise.all(selectedImageUrls.map(urlToBase64));
          
          setLoadingState('GENERATING_IMAGE');
    
          const response = await fetch('/api/gemini-image', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              prompt: prompts[selectedPrompt],
              images: base64Images
            })
          });

          if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.error || 'Image generation failed');
          }
          
          const result = await response.json();
          
          if (result.success) {
            setGeneratedImage(result.image);
            setCurrentStep(4);
          } else {
            throw new Error(result.error || 'Failed to generate image');
          }
    
        } catch (e) {
            setError(`An error occurred while generating the image: ${e.message}`);
        } finally {
          setLoadingState('IDLE');
        }
      };
    
      const handleDownloadImage = () => {
        if (generatedImage) {
          const link = document.createElement('a');
          link.href = generatedImage;
          link.download = 'ounass-look.png';
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
        }
      };
    
      // Resets the application to the first step
      const resetApp = () => {
        setSkus(['', '']);
        setProductImages({});
        setSelectedImages({});
        setPrompts({ studio: '', lifestyle: '' });
        setGeneratedImage(null);
        setError(null);
        setCurrentStep(1);
        setShowLifestyleForm(false);
        setLifestyleInputs({ location: '', mood: '', time: '', extra: '' });
      };
      
      // New function to go back to the prompts screen
      const backToPrompts = () => {
        setError(null);
        setCurrentStep(3);
      };
    
      // Renders a single step of the process
      const renderStep = () => {
        switch (currentStep) {
          case 1:
            return (
              <div className="flex flex-col space-y-4">
                <h2 className="text-xl font-semibold mb-2">1. Enter SKUs (Min 2, Max 5)</h2>
                {skus.map((sku, index) => (
                  <div key={index} className="flex items-center space-x-2">
                    <input
                      type="text"
                      placeholder={`SKU ${index + 1}`}
                      value={sku}
                      onChange={(e) => {
                        const newSkus = [...skus];
                        newSkus[index] = e.target.value;
                        setSkus(newSkus);
                      }}
                      className="flex-1 p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                    />
                    {skus.length > 2 && (
                      <button
                        onClick={() => setSkus(skus.filter((_, i) => i !== index))}
                        className="p-2 text-red-500 hover:text-red-700 transition-colors"
                      >
                        Remove
                      </button>
                    )}
                  </div>
                ))}
                <div className="flex justify-end space-x-2 mt-4">
                  {skus.length < 5 && (
                    <button
                      onClick={() => setSkus([...skus, ''])}
                      className="p-2 text-blue-500 hover:text-blue-700 transition-colors"
                    >
                      Add SKU
                    </button>
                  )}
                  <button
                    onClick={fetchImages}
                    disabled={skus.filter(s => s).length < 2 || loadingState !== 'IDLE'}
                    className="p-3 bg-blue-600 text-white rounded-lg shadow-md hover:bg-blue-700 transition-all disabled:bg-gray-400 disabled:cursor-not-allowed"
                  >
                    {loadingState === 'FETCHING_IMAGES' ? 'Loading...' : 'Fetch Images'}
                  </button>
                </div>
              </div>
            );
          case 2:
            return (
              <div className="flex flex-col space-y-6">
                <h2 className="text-xl font-semibold mb-2">2. Select Images</h2>
                {Object.keys(productImages).map(sku => (
                  <div key={sku} className="border-b pb-4">
                    <h3 className="text-lg font-medium mb-2">SKU: {sku}</h3>
                    <div className="flex flex-wrap gap-4 justify-center">
                      {productImages[sku].srcs.map((src, index) => (
                        <div
                          key={index}
                          className={`relative w-36 h-36 rounded-lg cursor-pointer overflow-hidden transition-all ${selectedImages[sku] === src ? 'ring-4 ring-blue-500 scale-105' : 'ring-2 ring-transparent hover:ring-blue-300'}`}
                          onClick={() => setSelectedImages(prev => ({ ...prev, [sku]: src }))}
                        >
                          <img src={src} alt={`SKU ${sku} - Image ${index + 1}`} className="w-full h-full object-cover" />
                        </div>
                      ))}
                    </div>
                  </div>
                ))}
                <div className="flex justify-end mt-4">
                  <button
                    onClick={generatePrompts}
                    disabled={Object.keys(selectedImages).length !== Object.keys(productImages).length}
                    className="p-3 bg-blue-600 text-white rounded-lg shadow-md hover:bg-blue-700 transition-all disabled:bg-gray-400 disabled:cursor-not-allowed"
                  >
                    Generate Prompts
                  </button>
                </div>
              </div>
            );
          case 3:
            return (
              <div className="flex flex-col space-y-6">
                <h2 className="text-xl font-semibold mb-2">3. Select a Prompt and Generate Image</h2>
                <div className="flex flex-wrap gap-6 mb-8 p-4 bg-gray-100 rounded-xl">
                  {Object.keys(selectedImages).map(sku => (
                    <div key={sku} className="flex-1 min-w-[200px] bg-white p-4 rounded-lg shadow-md flex flex-col items-center text-center">
                      <img src={selectedImages[sku]} alt={`Selected Product ${sku}`} className="w-24 h-24 object-contain mb-2 rounded-md" />
                      <p className="text-sm font-semibold mb-1">Product: {productImages[sku].name}</p>
                      <p className="text-xs text-gray-600">Brand: {productImages[sku].brand}</p>
                      <p className="text-xs text-gray-600">Category: {productImages[sku].category}</p>
                    </div>
                  ))}
                </div>
                <div className="flex flex-col space-y-4">
                  <div>
                    <label className="flex items-center justify-between cursor-pointer">
                      <div className="flex items-center space-x-2">
                        <input
                          type="radio"
                          name="prompt"
                          value="studio"
                          checked={selectedPrompt === 'studio'}
                          onChange={(e) => { setSelectedPrompt(e.target.value); setShowLifestyleForm(false); }}
                          className="form-radio text-blue-600"
                        />
                        <span className="font-medium text-lg">Studio Shoot Prompt:</span>
                      </div>
                      <button onClick={() => refreshPrompt('studio')} className="text-sm p-1 px-3 bg-gray-200 rounded-full hover:bg-gray-300 transition-colors">
                        Refresh
                      </button>
                    </label>
                    <textarea
                      value={prompts.studio}
                      onChange={(e) => setPrompts(prev => ({ ...prev, studio: e.target.value }))}
                      className="bg-gray-100 p-4 mt-2 rounded-lg text-sm text-gray-700 w-full h-24 resize-none focus:outline-none focus:ring-2 focus:ring-blue-500"
                      placeholder="Edit the prompt here..."
                    />
                  </div>
                  <div>
                    <label className="flex items-center justify-between cursor-pointer">
                      <div className="flex items-center space-x-2">
                        <input
                          type="radio"
                          name="prompt"
                          value="lifestyle"
                          checked={selectedPrompt === 'lifestyle'}
                          onChange={(e) => setSelectedPrompt(e.target.value)}
                          className="form-radio text-blue-600"
                        />
                        <span className="font-medium text-lg">Lifestyle Shoot Prompt:</span>
                      </div>
                      {!showLifestyleForm && (
                        <button
                          onClick={() => setShowLifestyleForm(true)}
                          className="text-sm p-1 px-3 bg-gray-200 rounded-full hover:bg-gray-300 transition-colors"
                        >
                          Generate Prompt
                        </button>
                      )}
                    </label>
                    {showLifestyleForm ? (
                      <div className="bg-gray-100 p-4 mt-2 rounded-lg text-sm text-gray-700 w-full">
                        <div className="flex flex-col space-y-2 mb-4">
                          <input
                            type="text"
                            placeholder="Location (e.g., 'a bustling city street')"
                            value={lifestyleInputs.location}
                            onChange={(e) => setLifestyleInputs(prev => ({ ...prev, location: e.target.value }))}
                            className="p-2 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                          />
                          <input
                            type="text"
                            placeholder="Mood (e.g., 'energetic and vibrant')"
                            value={lifestyleInputs.mood}
                            onChange={(e) => setLifestyleInputs(prev => ({ ...prev, mood: e.target.value }))}
                            className="p-2 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                          />
                          <input
                            type="text"
                            placeholder="Time of Day (e.g., 'golden hour at sunset')"
                            value={lifestyleInputs.time}
                            onChange={(e) => setLifestyleInputs(prev => ({ ...prev, time: e.target.value }))}
                            className="p-2 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                          />
                          <textarea
                            placeholder="Extra details? (e.g., 'rainy weather, with an umbrella')"
                            value={lifestyleInputs.extra}
                            onChange={(e) => setLifestyleInputs(prev => ({ ...prev, extra: e.target.value }))}
                            className="p-2 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 resize-none h-20"
                          />
                        </div>
                        <button
                          onClick={generateLifestylePrompt}
                          className="w-full p-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-all"
                        >
                          Generate Prompt
                        </button>
                      </div>
                    ) : (
                      <textarea
                        value={prompts.lifestyle}
                        onChange={(e) => setPrompts(prev => ({ ...prev, lifestyle: e.target.value }))}
                        className="bg-gray-100 p-4 mt-2 rounded-lg text-sm text-gray-700 w-full h-24 resize-none focus:outline-none focus:ring-2 focus:ring-blue-500"
                        placeholder="Click 'Generate Prompt' to create a custom lifestyle prompt based on your inputs..."
                      />
                    )}
                  </div>
                </div>
                <div className="flex justify-end items-center mt-4">
                  <button
                    onClick={handleGenerateImage}
                    disabled={loadingState !== 'IDLE'}
                    className="p-3 bg-blue-600 text-white rounded-lg shadow-md hover:bg-blue-700 transition-all disabled:bg-gray-400 disabled:cursor-not-allowed"
                  >
                    {loadingState === 'IDLE' ? 'Continue' : 'Generating...'}
                  </button>
                </div>
              </div>
            );
          case 4:
            return (
              <div className="flex flex-col items-center space-y-4">
                <h2 className="text-xl font-semibold mb-2">4. Generated Image</h2>
                {generatedImage ? (
                  <img src={generatedImage} alt="Generated Outfit" className="rounded-lg shadow-lg max-w-full h-auto" />
                ) : (
                  <div className="w-80 h-80 bg-gray-200 rounded-lg flex items-center justify-center">
                    <span className="text-gray-500">Image failed to load</span>
                  </div>
                )}
                <div className="flex space-x-4 mt-6">
                  <button
                    onClick={handleDownloadImage}
                    className="p-3 bg-green-600 text-white rounded-lg shadow-md hover:bg-green-700 transition-all"
                  >
                    Download
                  </button>
                  <button
                    onClick={backToPrompts}
                    className="p-3 bg-gray-600 text-white rounded-lg shadow-md hover:bg-gray-700 transition-all"
                  >
                    Back to Prompts
                  </button>
                  <button
                    onClick={resetApp}
                    className="p-3 bg-blue-600 text-white rounded-lg shadow-md hover:bg-blue-700 transition-all"
                  >
                    Start Over
                  </button>
                </div>
              </div>
            );
          default:
            return null;
        }
      };
    
      const getLoadingMessage = () => {
        switch (loadingState) {
          case 'FETCHING_IMAGES':
            return 'Fetching images from Ounass...';
          case 'GENERATING_PROMPTS':
            return 'Generating AI prompts...';
          case 'UPLOADING_IMAGES':
            return 'Preparing images for AI...';
          case 'GENERATING_IMAGE':
            return 'Generating image, this may take a moment...';
          default:
            return 'Please wait...';
        }
      };
    
      return (
        <div className="min-h-screen bg-gray-100 p-8 flex items-center justify-center font-sans">
          <div className="w-full max-w-3xl bg-white rounded-2xl shadow-xl p-8 transform transition-all duration-300 ease-in-out hover:scale-[1.01] border-4 border-white">
            <div className="flex flex-col items-center text-center mb-8">
              <h1 className="text-4xl font-bold text-gray-800 mb-2">Ounass Outfit Generator</h1>
              <p className="text-gray-500">Create custom outfits from SKUs for personal shopping.</p>
              <button 
                onClick={async () => {
                  try {
                    const response = await fetch('/api/test');
                    const data = await response.json();
                    console.log('API Test Result:', data);
                    alert(`API Test: ${data.message}\nEnvironment: ${data.env}`);
                  } catch (error) {
                    console.error('API Test Error:', error);
                    alert('API Test Failed: ' + error.message);
                  }
                }}
                className="mt-4 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-all"
              >
                Test API Connection
              </button>
            </div>
    
            {error && (
              <div className="p-4 mb-6 text-sm text-red-700 bg-red-100 rounded-lg text-center font-medium">
                {error}
              </div>
            )}
    
            {loadingState !== 'IDLE' && (
              <div className="fixed inset-0 bg-white bg-opacity-75 flex items-center justify-center z-50 p-4">
                <div className="flex flex-col items-center p-6 bg-white rounded-xl shadow-lg">
                  <div className="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-blue-500"></div>
                  <p className="mt-4 text-gray-600 font-semibold">{getLoadingMessage()}</p>
                  
                  {/* Progress indicator for image fetching */}
                  {loadingState === 'FETCHING_IMAGES' && (
                    <div className="mt-4 text-center">
                      <div className="w-64 bg-gray-200 rounded-full h-2 mb-2">
                        <div 
                          className="bg-blue-600 h-2 rounded-full transition-all duration-300"
                          style={{ 
                            width: `${Math.min((Object.keys(productImages).length / Math.max(skus.filter(s => s).length, 1)) * 100, 100)}%` 
                          }}
                        ></div>
                      </div>
                      <p className="text-sm text-gray-500">
                        {Object.keys(productImages).length} of {skus.filter(s => s).length} SKUs processed
                      </p>
                      <p className="text-xs text-gray-400 mt-1">
                        Using multiple proxy services for faster loading
                      </p>
                    </div>
                  )}
                  
                  {Object.keys(selectedImages).length > 0 && (
                    <div className="flex flex-wrap gap-4 mt-6">
                      {Object.values(selectedImages).map((src, index) => (
                        <img key={index} src={src} alt="Selected item" className="w-16 h-16 object-cover rounded-md shadow" />
                      ))}
                    </div>
                  )}
                </div>
              </div>
            )}
            
            {renderStep()}
          </div>
        </div>
      );
    };
    
    // Render the App component to the root element
    ReactDOM.render(<App />, document.getElementById('root'));
    
  </script>
</body>
</html>
