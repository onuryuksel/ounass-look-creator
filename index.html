<!DOCTYPE html>
<html lang="tr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Fotoğraf Stüdyosu</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');

        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }

        .container {
            max-width: 800px;
        }
    </style>
</head>

<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">

    <!-- Ana Konteyner -->
    <div class="container mx-auto p-8 bg-white rounded-lg shadow-xl">
        <h1 class="text-3xl font-bold text-center text-gray-800 mb-6">AI Fotoğraf Stüdyosu</h1>
        <p class="text-center text-gray-600 mb-8">Ürününüzün fotoğrafını yükleyin ve yapay zeka tarafından oluşturulan çarpıcı bir sahneye yerleştirin.</p>

        <!-- Yükleme Alanı -->
        <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center mb-6">
            <label for="file-upload" class="cursor-pointer">
                <div class="flex flex-col items-center justify-center">
                    <svg class="w-12 h-12 text-gray-400 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                        xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M7 16a4 4 0 01-4-4v-1a4 4 0 014-4h12a4 4 0 014 4v1a4 4 0 01-4 4H7z"></path>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v8m-4-4h8">
                        </path>
                    </svg>
                    <p class="text-sm text-gray-500">Fotoğraf yüklemek için buraya tıklayın veya sürükleyip bırakın</p>
                    <p class="text-xs text-gray-400 mt-1">Sadece .jpg veya .png dosyaları kabul edilir.</p>
                </div>
            </label>
            <input id="file-upload" type="file" class="hidden" accept=".jpg,.jpeg,.png">
        </div>

        <!-- Yüklenen Görüntü Önizlemesi -->
        <div id="image-preview" class="hidden mb-6">
            <h3 class="text-xl font-semibold mb-2 text-center text-gray-700">Yüklenen Ürün</h3>
            <img id="uploaded-image" src="#" alt="Yüklenen ürün önizlemesi"
                class="mx-auto rounded-lg shadow-md max-w-full h-auto" />
        </div>

        <!-- AI Ayarları -->
        <div class="space-y-4 mb-8">
            <label class="block">
                <span class="text-gray-700 font-medium">Ürün Açıklaması</span>
                <input id="product-description" type="text"
                    class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50 p-2"
                    placeholder="Örn: parlak kırmızı spor ayakkabı">
            </label>
            <label class="block">
                <span class="text-gray-700 font-medium">İstediğiniz Stil</span>
                <input id="style-input" type="text"
                    class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50 p-2"
                    placeholder="Örn: şehir sokaklarında neon ışıklı fütüristik sahne">
            </label>
        </div>

        <!-- İşlem Düğmeleri -->
        <div class="flex justify-center space-x-4">
            <button id="generate-btn"
                class="px-6 py-3 bg-indigo-600 text-white font-semibold rounded-lg shadow-lg hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 transition duration-300 ease-in-out">
                Oluştur
            </button>
            <button id="clear-btn"
                class="px-6 py-3 bg-gray-300 text-gray-800 font-semibold rounded-lg shadow-lg hover:bg-gray-400 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2 transition duration-300 ease-in-out">
                Temizle
            </button>
        </div>

        <!-- Yükleme Durumu ve Mesajlar -->
        <div id="status-message" class="mt-8 text-center text-gray-600 hidden">
            <p>Görsel oluşturuluyor, lütfen bekleyin...</p>
        </div>
        <div id="error-message" class="mt-8 text-center text-red-500 hidden">
            <p>Bir hata oluştu. Lütfen tekrar deneyin.</p>
        </div>

        <!-- Sonuç Alanı -->
        <div id="result-container" class="hidden mt-8">
            <h3 class="text-xl font-semibold text-center mb-4 text-gray-700">Oluşturulan Görsel</h3>
            <img id="generated-image" src="#" alt="Yapay zeka tarafından oluşturulan görsel"
                class="mx-auto rounded-lg shadow-xl max-w-full h-auto" />
        </div>

    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const fileUpload = document.getElementById('file-upload');
            const imagePreviewContainer = document.getElementById('image-preview');
            const uploadedImage = document.getElementById('uploaded-image');
            const productDescription = document.getElementById('product-description');
            const styleInput = document.getElementById('style-input');
            const generateBtn = document.getElementById('generate-btn');
            const clearBtn = document.getElementById('clear-btn');
            const statusMessage = document.getElementById('status-message');
            const errorMessage = document.getElementById('error-message');
            const resultContainer = document.getElementById('result-container');
            const generatedImage = document.getElementById('generated-image');

            let uploadedFile = null;

            // Vercel ortam değişkenini kullanmak için API anahtarını güncellendi.
            const apiKey = process.env.API_KEY || ""; 

            fileUpload.addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (file) {
                    uploadedFile = file;
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        uploadedImage.src = e.target.result;
                        imagePreviewContainer.classList.remove('hidden');
                    };
                    reader.readAsDataURL(file);
                }
            });

            generateBtn.addEventListener('click', async () => {
                if (!uploadedFile) {
                    alert('Lütfen bir ürün fotoğrafı yükleyin.');
                    return;
                }

                statusMessage.classList.remove('hidden');
                errorMessage.classList.add('hidden');
                resultContainer.classList.add('hidden');
                generatedImage.src = '';

                try {
                    const base64ImageData = await new Promise((resolve) => {
                        const reader = new FileReader();
                        reader.onload = () => resolve(reader.result.split(',')[1]);
                        reader.readAsDataURL(uploadedFile);
                    });

                    // Metin prompt'u için API çağrısı
                    const textPrompt = `A high-quality image of ${productDescription.value || 'a product'} with the style of '${styleInput.value || 'a professional studio setting'}'.`;

                    const promptPayload = {
                        contents: [{
                            parts: [{
                                text: textPrompt
                            }]
                        }],
                        generationConfig: {
                            responseModalities: ['TEXT', 'IMAGE']
                        }
                    };

                    const promptUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-image-preview:generateContent?key=${apiKey}`;

                    let retries = 0;
                    const maxRetries = 5;

                    const fetchPrompt = async () => {
                        try {
                            const response = await fetch(promptUrl, {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify(promptPayload)
                            });

                            if (!response.ok) {
                                throw new Error(`API hatası: ${response.statusText}`);
                            }

                            const result = await response.json();
                            const base64Data = result?.candidates?.[0]?.content?.parts?.find(p => p.inlineData)?.inlineData?.data;

                            if (base64Data) {
                                const imageUrl = `data:image/png;base64,${base64Data}`;
                                generatedImage.src = imageUrl;
                                resultContainer.classList.remove('hidden');
                            } else {
                                throw new Error('API yanıtından görüntü verisi alınamadı.');
                            }
                        } catch (error) {
                            if (retries < maxRetries) {
                                retries++;
                                const delay = Math.pow(2, retries) * 1000;
                                console.log(`İstek başarısız, tekrar denemeden önce ${delay / 1000} saniye bekleniyor...`);
                                await new Promise(res => setTimeout(res, delay));
                                await fetchPrompt();
                            } else {
                                throw error;
                            }
                        }
                    };

                    await fetchPrompt();

                } catch (error) {
                    console.error('API çağrısı sırasında bir hata oluştu:', error);
                    errorMessage.classList.remove('hidden');
                } finally {
                    statusMessage.classList.add('hidden');
                }
            });

            clearBtn.addEventListener('click', () => {
                fileUpload.value = '';
                uploadedFile = null;
                imagePreviewContainer.classList.add('hidden');
                productDescription.value = '';
                styleInput.value = '';
                resultContainer.classList.add('hidden');
                generatedImage.src = '';
                statusMessage.classList.add('hidden');
                errorMessage.classList.add('hidden');
            });
        });
    </script>
</body>

</html>
